<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Bananas</title>

    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/highlight.min.css"/>

    <!-- Load polyfills to support older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>

    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>

    <script src="js/ethers-5.2.umd.min.js"></script>
    <script src="js/highlight.min.js"></script>
    <script src="bananaData.min.js"></script>
    <script src="moonCatData.min.js"></script>
    <script src="mooncatfunctions.js"></script>
    <script src="js/mooncatparser.js"></script>
    <script src="deploymentData.js"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-2">
        <div>
          <b-navbar variant="light">
            <b-navbar-brand to="./" variant="primary">
              Bananas
            </b-navbar-brand>
            <img src="images/Banana_2952_nobg.png" class="ml-3" style="max-width: 40px;" alt="Banana #2952" v-b-popover.hover.bottom="'Banana #2952'" />
            <img src="images/Banana_636_nobg.png" class="ml-3" style="max-width: 40px;" alt="Banana #636" v-b-popover.hover.bottom="'Banana #636'" />
            <b-navbar-nav class="ml-auto">
              <b-button size="sm" variant="outline-primary" class="ml-4" v-b-popover.hover="'Power up this app'" @click="connect();" v-if="!connected">Connect to Web3</b-button>
              <b-button size="sm" variant="outline-primary" class="ml-4" v-b-popover.hover="'Power down this app'" @click="disconnect();" v-if="connected">Disconnect from {{ account.substring(0, 10) }}</b-button>
            </b-navbar-nav>
          </b-navbar>
        </div>

        <div>
          <b-card no-body class="mt-1">
            <b-tabs card v-model="tabIndex">

              <b-tab active title="Search Bananssaas">
                <b-card-text>
                  <div class="d-flex m-0 p-0" style="height: 37px;">
                    <div>
                      <b-form-input type="text" size="sm" v-model.trim="searchString" debounce="600" placeholder="Search..." v-b-popover.hover="'Search by tokenId'"></b-form-input>
                    </div>
                    <div class="pl-1">
                      <b-form-select size="sm" v-model="searchYear" :options="searchYearOptions"></b-form-select>
                    </div>
                    <div class="pl-1">
                      {{ getBananaSearchResultsRows }}/{{ getBananaTotalSupply }}
                    </div>
                    <div class="pr-1 flex-grow-1">
                    </div>
                    <!--
                    <div class="pl-1">
                      <b-form-checkbox size="sm" v-model="displayAcclimated" v-b-popover.hover="'Use Acclimated MoonCat images instead of generating the images from the catId'" class="pt-1">Acclimated</b-form-select>
                    </div>
                    -->
                    <div class="pl-1">
                      <b-form-select size="sm" v-model="view" :options="viewOptions"></b-form-select>
                    </div>
                    <div class="pl-1">
                      <b-pagination size="sm" v-model="searchCurrentPage" :total-rows="getBananaSearchResultsRows" :per-page="searchPerPage"></b-pagination>
                    </div>
                    <div class="pl-1">
                      <b-form-select size="sm" v-model="searchPerPage" :options="searchPerPageOptions"></b-form-select>
                    </div>
                  </div>

                  <div v-if="view == 'cards'">
                    <b-card-group deck>
                      <div v-for="record in getBananaSearchResultsPage">
                        <!-- <b-card body-class="p-1 d-flex align-items-end justify-content-center" img-bottom img-center header-class="p-1" footer-class="p-2" style="width: 10rem; height: 12.2rem;" img-top class="m-1 p-0 text-center text-bottom position-relative"> -->
                        <b-card style="width: 10rem; height: 14rem;" class="mt-1">
                          <template #header>
                            <span variant="secondary" class="small truncate">
                              {{ record.tokenId + ': ' + record.name }}
                            </span>
                          </template>
                          <b-link :href="record.permalink + '?ref=0x000001f568875F378Bf6d170B790967FE429C81A'" v-b-popover.hover="'View on OpenSea.io'" target="_blank">
                            <b-img-lazy width="100%" :src="record.osimage" />
                          </b-link>

                          <!--
                          <template #footer>
                            {{ getFooter(slumDoge, rescueIndex) }}
                          </template>
                          -->
                        </b-card>
                      </div>
                    </b-card-group>
                  </div>
                  <div v-if="view == 'list'">
                    <b-table small :fields="fields" :items="getBananaSearchResultsPage" responsive="sm">
                      <template #cell(image)="data">
                        <b-link :href="data.item.permalink + '?ref=0x000001f568875F378Bf6d170B790967FE429C81A'" v-b-popover.hover="'View on OpenSea.io'" target="_blank">
                          <b-img-lazy width="100%" :src="data.item.osimage" />
                        </b-link>
                      </template>
                    </b-table>
                  </div>
                </b-card-text>
              </b-tab>

              <b-tab title="My Wallet">
                <b-card-text>
                  <b-button :disabled="!connected" variant="outline-success" @click="retrieveData">Retrieve Data</b-button>
                  {{ owned }}
                </b-card-text>
              </b-tab>

              <b-tab title="References">
                <b-card-text>
                  References:

                    * Blah
                    <!--
                    <b-link href="https://mooncatrescue.com/adopt.html" target="_blank">https://mooncatrescue.com/adopt.html</b-link>
                    <br />
                    <br />
                    <b-link href="https://github.com/ponderware/mooncatparser/blob/master/mooncatparser.js" target="_blank">https://github.com/ponderware/mooncatparser/blob/master/mooncatparser.js</b-link>
                    <br />
                    <b-link href="https://github.com/bokkypoobah/MoonCatExplainer" target="_blank">https://github.com/bokkypoobah/MoonCatExplainer</b-link>
                    -->
                </b-card-text>
              </b-tab>
            </b-tabs>
          </b-card>
        </div>
      </b-container>
    </div>

    <!-- Start running app -->
    <script>
      window.app = new Vue({
        el: '#app',
        data: {
          connected: false,
          account: null,
          owned: {},
          tabIndex: 0,
          abortSearch: false,
          searchString: '',
          searchCurrentPage: 1,
          searchTotalRows: 25440,
          searchPerPage: 100,
          searchPerPageOptions: [
            { value: 100, text: '100/p' },
            { value: 1000, text: '1,000/p' },
            { value: 1000, text: '10,000/p' },
            { value: 100000, text: 'All' }
          ],
          searchYear: null,
          searchYearOptions: [
            { value: null, text: 'All' },
            { value: 2017, text: '2017' },
            { value: 2018, text: '2018' },
            { value: 2019, text: '2019' },
            { value: 2020, text: '2020' },
            { value: 2021, text: '2021' },
          ],
          view: 'list', // 'cards',
          viewOptions: [
            { value: 'cards', text: 'Cards' },
            { value: 'list', text: 'List' },
          ],
          displayAcclimated: false,
          fields: [
            { key: 'tokenId', label: 'tokenId' },
            { key: 'name', label: 'name' },
            { key: 'image', label: 'image' },
            { key: 'signatureSeries', label: 'signatureSeries' },
            { key: 'background', label: 'background' },
            { key: 'bananaBase', label: 'bananaBase' },
            { key: 'mouth', label: 'mouth' },
            { key: 'eyes', label: 'eyes' },
            { key: 'headGear', label: 'headGear' },
            { key: 'attributes', label: 'attributes' },
            // d.background = background;
            // d.bananaBase = bananaBase;
            // d.mouth = mouth;
            // d.eyes = eyes;
            // d.headGear = headGear;
            // d.signatureSeries = signatureSeries;
          ],
        },
        computed: {
          getBananaData() {
            const results = [];
            for (let i in BANANADATA) {
              const d = BANANADATA[i];
              let signatureSeries = null;
              let background = null;
              let bananaBase = null;
              let mouth = null;
              let eyes = null;
              let headGear = null;
              for (let k in d.attributes) {
                const a = d.attributes[k];
                // console.log(k + " => " + JSON.stringify(a));
                if (a.trait_type == 'Background') {
                  background = a.value;
                } else if (a.trait_type == 'Banana Base') {
                  bananaBase = a.value;
                } else if (a.trait_type == 'Mouth') {
                  mouth = a.value;
                } else if (a.trait_type == 'Eyes') {
                  eyes = a.value;
                } else if (a.trait_type == 'Head Gear') {
                  headGear = a.value;
                } else if (a.trait_type == 'Signature Series') {
                  signatureSeries = a.value;
                }
              }
              if (!signatureSeries && (background == null || bananaBase == null || mouth == null || eyes == null || headGear == null)) {
                console.log("signatureSeries: " + signatureSeries);
                console.log("tokenId: " + i);
                console.log("d: " + JSON.stringify(d));
                console.log("background: " + background);
                console.log("bananaBase: " + bananaBase);
                console.log("mouth: " + mouth);
                console.log("eyes: " + eyes);
                console.log("headGear: " + headGear);
              }

              d.background = background;
              d.bananaBase = bananaBase;
              d.mouth = mouth;
              d.eyes = eyes;
              d.headGear = headGear;
              d.signatureSeries = signatureSeries;

              if (i == 636 || i == 8412) {
                console.log(JSON.stringify(d, null, 2));
              }

              results.push(d);
            }
            return results;
          },
          getBananaTotalSupply() {
            return BANANADATA.length;
          },
          getBananaSearchResults() {
            let results = [];
            if (this.searchString != null && this.searchString.length > 0) {
              for (let i in this.getBananaData) {
                const d = this.getBananaData[i];
                // if (d.rescueIndex == this.searchString || d.catId.includes(this.searchString) || d.rescued.block == this.searchString || d.rescued.tx.includes(this.searchString) || d.rescued.by.includes(this.searchString) || d.colour.includes(this.searchString)) {
                //   results1.push(d);
                // }
                if (d.tokenId == this.searchString || d.name.includes(this.searchString)) {
                  results.push(d);
                }
              }
            } else {
              results = this.getBananaData;
            }
            return results;
          },
          getBananaSearchResultsPage() {
            const currentPage = this.searchCurrentPage;
            const perPage = this.searchPerPage;
            return this.getBananaSearchResults.slice((currentPage - 1) * perPage, currentPage * perPage);
          },
          getBananaSearchResultsRows() {
            return this.getBananaSearchResults.length;
          },
        },
        methods: {
          async connect() {
            if (!window.ethereum) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser to view this page");
              this.connected = false;
              this.account = null;
            } else {
              if (!window.ethereum.isConnected() || !window.ethereum['isUnlocked']) {
                try {
                  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                  this.account = accounts[0];
                } catch (e) {
                  console.log("connect(): Error connecting");
                }
              }
              this.connected = true;
            }
          },
          disconnect() {
            this.connected = false;
          },
          async retrieveData() {
            console.log("retrieveData");
            const provider = new ethers.providers.Web3Provider(window.ethereum);

            const moonCatRescue = new ethers.Contract(MOONCATRESCUEADDRESS, MOONCATRESCUEABI, provider);
            // const totalSupply = await moonCatRescue.totalSupply();
            // console.log("retrieveData: execWeb3() moonCatRescue.totalSupply: " + totalSupply.toString());
            // const rescueIndex = await moonCatRescue.rescueIndex();
            // console.log("retrieveData: execWeb3() moonCatRescue.rescueIndex: " + rescueIndex.toString());
            // const catIds = await moonCatRescue.getCatIds();
            // console.log(JSON.stringify(catIds));
            // try {
            //   const names = await moonCatRescue.getCatNames();
            //   console.log(JSON.stringify(names));
            // } catch (e) {
            //   console.log(e.getMessage);
            // }

            let owned = {};
            let attempts = 1;
            let success = false;
            do {
              try {
                console.log("Retrieving owners, attempt: " + attempts);
                const owners = await moonCatRescue.getCatOwners();
                const a = this.account.toString();
                for (let i = 0; i < owners.length; i++) {
                  const o = owners[i].toString().toLowerCase();
                  if (!a.localeCompare(o)) {
                    owned[i] = { rescueIndex: i, owner: o, contract: 'Original' };
                  }
                }
                success = true;
              } catch (e) {
                console.log(e.getMessage);
              }
            } while (!success && attempts++ <= 10);

            const acclimatedMoonCat = new ethers.Contract(ACCLIMATEDMOONCATADDRESS, ACCLIMATEDMOONCATABI, provider);
            const tokensIdsByOwner = await acclimatedMoonCat.tokensIdsByOwner(this.account);
            for (let i = 0; i < tokensIdsByOwner.length; i++) {
              const rescueIndex = tokensIdsByOwner[i].toString();
              owned[rescueIndex] = { rescueIndex: rescueIndex, owner: this.account, contract: 'Acclimated' };
            }

            // Testing
            const account = "0x1c46718463877607b620aa26d10e75bc771ba24e";
            const wrappedMoonCat = new ethers.Contract(WRAPPEDMOONCATADDRESS, WRAPPEDMOONCATABI, provider);
            const balanceOf = await wrappedMoonCat.balanceOf(account);
            for (let i = 0; i < balanceOf; i++) {
              const tokenOfOwnerByIndex = await wrappedMoonCat.tokenOfOwnerByIndex(account, i);
              const catId = await wrappedMoonCat._tokenIDToCatID(tokenOfOwnerByIndex);
              const rescueIndex = this.getMoonCatCatIdToRescueIndex[catId];
              owned[rescueIndex] = { rescueIndex: rescueIndex, owner: this.account, contract: 'Wrapped' };
            }
            this.owned = owned;
          },
          generateMoonCatImage(catId, size) {
            if (this.catId.substring(0, 2) == "0x" && this.catId.length >= 12) {
              size = size || 10;
              var data = moonCatParser(catId);
              var canvas = document.createElement("canvas");
              canvas.width = size * data.length;
              canvas.height = size * data[1].length;
              var ctx = canvas.getContext("2d");

              for(var i = 0; i < data.length; i++){
                for(var j = 0; j < data[i].length; j++){
                  var color = data[i][j];
                  if(color){
                    ctx.fillStyle = color;
                    ctx.fillRect(i * size, j * size, size, size);
                  }
                }
              }
              return canvas.toDataURL();
            }
            return null;
          },
          loadCat(catId) {
            this.catId = catId;
            this.tabIndex = 0;
          },
          toHex2(num) {
            let str = num.toString(16);
            while (str.length < 2) {
              str = "0" + str;
            }
            return str;
          },
          toBin8(num) {
            let str = num.toString(2);
            while (str.length < 8) {
              str = "0" + str;
            }
            return str;
          },
          catIdWithK(k) {
            if (this.catId.substring(0, 2) == "0x" && this.catId.length >= 12) {
              let str = k.toString(16);
              if (str.length < 2) {
                str = "0" + str;
              }
              return this.catId.substring(0, 4) + str + this.catId.substring(6);
            }
            return null;
          },
          showModal() {
            var searchSeed = "8363e7eaae8e35b1c2db100a7b0fb9db1bc604a35ce1374d882690d0b1d888e2";
            var seed;
            var result = ethers.utils.hashMessage(new Date().toString());
            async function hello() {
              console.log("  In Hello");
              // while (result.substring(0, 8) != "0x000000") {
              while (result.substring(0, 6) != "0x0000") {
                seed = result;
                result = ethers.utils.hashMessage(seed + searchSeed, {encoding: 'hex'});
              }
              console.log("    seed=" + seed);
              console.log("    result=" + result);
              console.log("  Out of Hello");
              return greeting = await Promise.resolve("Hello");
            };
            hello(); // .then(alert);
            // console.log(ethers.utils.hashMessage("Hello World"));
          }
        },
        mounted() {
          hljs.highlightAll();
        }
      })
    </script>
  </body>
</html>
